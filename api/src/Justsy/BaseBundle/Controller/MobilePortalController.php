<?phpnamespace Justsy\BaseBundle\Controller;use Symfony\Bundle\FrameworkBundle\Controller\Controller;use Justsy\BaseBundle\DataAccess\SysSeq;use Symfony\Component\HttpFoundation\Response;use Symfony\Component\HttpFoundation\Request;use Justsy\BaseBundle\Login\UserSession;use Justsy\BaseBundle\Common\Utils;use Justsy\BaseBundle\Common\DES;use Symfony\Component\Security\Core\Authentication\Token\UsernamePasswordToken;use Symfony\Component\Security\Http\Event\InteractiveLoginEvent;class MobilePortalController extends Controller{    public function indexAction()    {        $portal = new \Justsy\BaseBundle\Management\Portal($this->container);        $info = $portal->GetPortInfo();        $info = json_encode($info);        return $this->render("JustsyBaseBundle:MobilePortal:index.html.twig",array("portal_info"=>$info));    }        //上传门户图标    public function uploadPicAction()    {        $da = $this->get("we_data_access");        $request = $this->getrequest();        $fileElementName=$request->get("filename");        $success = true;$msg="";$fileid="";        try         {            $filename=$_FILES[$fileElementName]['name'];            $filesize=$_FILES[$fileElementName]['size'];            $filetemp=$_FILES[$fileElementName]['tmp_name'];	            $dm = $this->get('doctrine.odm.mongodb.document_manager');                     $fileid = Utils::saveFile($filetemp,$dm);            if(empty($fileid))            {                $success = false;                $msg ='文件上传失败';            }        }        catch(\Exception $e){            $this->logger->err($e->getMessage());            $msg =$e->getMessage();        }        $result = array("success"=>$success,"msg"=>$msg,"fileid"=>$fileid);        $response = new Response(json_encode($result));        $response->headers->set('Content-Type', 'text/json');        return $response;    }           //保存门户图标    public function updatePortalIconAction()    {        $da = $this->get("we_data_access");        $user=$this->get('security.context')->getToken()->getUser();        $eno = $user->eno;        $username=$user->getUsername();        $request=$this->getRequest();        $logo=$request->get("fileid");        $crop=$request->get("crop");        if(!empty($crop))        {        	 $crop = json_decode($crop,true);        }        $appid=$request->get("appid");        $success = true;        $newfileid = "";        if(!empty($logo) && !empty($crop))        {        	//源图像另存为        	 $doc = $this->get('doctrine.odm.mongodb.document_manager')                  ->getRepository('JustsyMongoDocBundle:WeDocument')                  ->find($logo);            if (!empty($doc))            {                $filename1 = strtolower( $doc->getName());            	  $expname =explode(".", $filename1);            	  $expname = $expname[1];            	            	  $src = tempnam(sys_get_temp_dir(), "tmp").".".$expname;            	  $file = $doc->getFile();		    	            	  $filename2 = $file->getFilename();            	  $tybes = $file->getBytes();        		    $cont =fopen($src,'w');        		    fwrite($cont,$tybes);        		    fclose($cont);                		    $gd = new \Justsy\AppCenterBundle\Common\Gd();        		    $gd->open( $src );        		            		    if( $gd->is_image() )        		    {        		        $gd->crop((int)$crop["x"], (int)$crop["y"], (int)$crop["w"], (int)$crop["h"]);        			      $gd->resize_to(180,180, 'force');        			      $gd->save_to($src);                			      $dm = $this->get('doctrine.odm.mongodb.document_manager');            		    $doc = new \Justsy\MongoDocBundle\Document\WeDocument();            		    $doc->setName(basename($src));            		    $doc->setFile($src);            		    $dm->persist($doc);            		    $dm->flush();            		    $newfileid  = $doc->getId();          		  }        		    unlink($src);        		    //数据记录操作处理        		    $sql="update we_apps_portalconfig set logo=? where appid=?";                $params=array((string)$newfileid ,$appid);                //删除原来的文件                $dm = $this->get('doctrine.odm.mongodb.document_manager');                Utils::removeFile($logo,$dm);                                try                {                    $da->ExecSQL($sql,$params);                }                catch(\Exception $e)                {                    $success = false;                    $this->get("logger")->err($e->getMessage());                                        }                    }        }        $re = array("success"=>$success,"fileid"=>$newfileid);        $result = new Response(json_encode($re));        $result->headers->set('Content-Type', 'text/json');        return $result;    }}